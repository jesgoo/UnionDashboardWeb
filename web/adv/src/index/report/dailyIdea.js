/**
 * @file Generated by er-sync
 * @author killeryyl<longgeyang@jesgoo.com>
 * @date Mon Sep 28 2015 14:26:57 GMT+0800 (CST)
 * Copyright (c) 2015 jesgoo.com, Inc. All Rights Reserved
 */
(function () {
    mf.index.report.dailyIdea = new er.Action({
        model: mf.index.report.model.dailyIdea,
        view: new er.View({
            template: 'mf_index_report_dailyIdea',
            UI_PROP: {}
        }),
        STATE_MAP: {
            'dateRegion': mf.getDateString(mf.getDate(-7)) + ',' +
                          mf.getDateString(mf.getDate(-1))
        },

        onenter: function () {
            console.log('onenter');
            mf.onenter();
        },
        onafterrender: function () {
            console.log('onafterrender');
            var action = this;
            var model = action.model;
            var dateRegion = esui.get('dailyIdeaDateRegion');
            dateRegion.onchange = mf.m.utils.nextTickWrapper(function (value, name, index) {
                console.log('date change', name, index);
                mf.subActionRefresh(action, {
                    dateRegion: dateRegion.getValue()
                });
            }, dateRegion);
        },
        onentercomplete: function () {
            console.log('onentercomplete');
            mf.loaded();
            var action = this;
            var model = action.model;
            var data = model.get('lists');
            if (data.length) {
                var total = data.reduce(function (memory, n) {
                    memory.impression += n.impression || 0;
                    memory.click += n.click || 0;
                    memory.cost += n.cost || 0;
                    return memory;
                }, {
                    date: '总计',
                    impression: 0,
                    click: 0,
                    cost: 0,
                    ctr: 0,
                    cpm: 0
                });
                if (total.impression) {
                    total.ctr = total.click / total.impression * 100;
                    total.cpm = total.cost / total.impression * 1000;
                }
            }

            mf.mockPager(data, {
                table: esui.get('dailyIdeaList')
            }, {
                afterSort: function (dataList, targets, opt) {
                    total && (targets.table.datasource || []).unshift(total);
                }
            })();

            var dateRegion = esui.get('dailyIdeaDateRegion');
            mf.m.highchart_overview('#dailyIdeaChart', model.get('lists'), dateRegion.getValueAsObject());
        },
        onleave: function () {
            console.log('onleave');
        }
    });
})();