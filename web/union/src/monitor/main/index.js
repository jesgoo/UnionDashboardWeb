/**
 * @file Generated by er-sync
 * @author killeryyl<longgeyang@jesgoo.com>
 * @date Thu Apr 09 2015 17:17:07 GMT+0800 (CST)
 * Copyright (c) 2015 jesgoo.com, Inc. All Rights Reserved
 */
(function () {

    function convertData(data) {
        var result = {
            data: {},
            time: []
        };
        //console.log('convertData', data);
        var timeMap = $.deepExtend({}, data);
        $.each(timeMap, function (time, list) {
            result.time.push(time);
            $.each(list, function (field, counters) {
                var count = 0;
                var sum = 0;
                $.each(counters, function (key, value) {
                    count += 1;
                    sum += +value || 0;
                });
                list[field] = {
                    count: count,
                    sum: sum
                };
            });
        });
        result.time.sort(function (a, b) {
            return a > b ? -1 : 1;
        });
        result.time.length = 720 * 9;
        result.time.splice(720 * 3, 720 * 4);
        result.time.reverse();
        var timeDistance = 0;
        var previousIndex = result.time.length;
        while (previousIndex > 0) {
            var currentIndex = previousIndex - 720;
            if (currentIndex < 0) {
                currentIndex = 0
            }
            var timeList = result.time.slice(currentIndex, previousIndex);
            //console.log('convertData', timeDistance, currentIndex, previousIndex, timeList);
            $.each(mf.monitor.main.model.fieldMap, function (field) {
                result.data[field] = result.data[field] || {};
                var target = result.data[field][timeDistance] = [];
                $.each(timeList, function (index, time) {
                    var item = timeMap[time] || {};
                    var value = item[field];
                    target[index] = value && value.sum || 0;
                });
                if (timeList.length < 720) {
                    console.log('补充时间');
                    target.splice.apply(target, mf.monitor.main.model.emptyData.slice(0, 720 - target.length + 2));
                }
            });
            previousIndex = currentIndex;
            timeDistance += 1;
        }
        return result;

    }

    function requestData(requestURL, target) {
        //console.log('requestData', requestURL);
        return $.getJSON(requestURL).pipe(mf.monitor.main.model.parseData.bind(null, target));
    }

    function RunMonitor(charElement, lookBackDays) {
        lookBackDays = lookBackDays || -3;
        console.log('RunMonitor', charElement);
        var me = this;
        me.monitorList = $.map(mf.monitor.main.model.machineList, function (machine) {
            var requestURL = mf.ajaxParamFactory({
                url: '/machine/' + machine + ':' + mf.monitor.main.model.realTimePort + '/getdata_last'
            });
            return requestURL.url;

        });
        var logField = $.map(mf.monitor.main.model.fieldMap, function (obj, field) {
            return field + '.log';
        }).join(',');
        var historyList = $.map(mf.monitor.main.model.machineList, function (machine) {
/*
            return '/machine/' + machine + ':' + mf.monitor.main.model.historyPort + '/index?'
                   + 'begin=' + mf.monitor.main.model.getDateTime(lookBackDays) + '&end=' + mf.monitor.main.model.getDateTime() + '&name=' + logField;
*/
            return mf.ajaxParamFactory({
                url: '/machine/' + machine + ':' + mf.monitor.main.model.realTimePort + '/getdata'
            }).url;
        });
        var dataRequest = $.map(historyList, function (requestURL, index) {
            return requestData(requestURL, mf.monitor.main.model.machineList[index]);
        });
        /*var dataRequest = $.map(historyList, function (requestURL, index) {
            var def = $.Deferred();
            mf.parallelAjax(requestURL, function (data) {
                var historyData = $.map(data, function (fieldData, field) {
                    return {
                        table_name: field,
                        counters: $.map(fieldData, function (n) {
                            return {
                                //time: new Date(n.time.replace(/\-/g, '/').replace(':', " ")).getTime() / 1000,
                                time: n.time,
                                number: n.value
                            }
                        })
                    }
                });
                def.resolve(mf.monitor.main.model.parseData(mf.monitor.main.model.machineList[index], historyData));
            });
            return def.promise();
        });*/
        $.when.apply($, dataRequest)
            .pipe(mf.monitor.main.model.mergeData)
            .done(function (data) {
                me.data = data;
                me.chart = {};
                me.element = {};
                var chartData = convertData(data);
                $.each(mf.monitor.main.model.fieldMap, function (field, opt) {
                    me.element[field] = $('<div/>', {id: 'chart_' + field}).appendTo(charElement);
                    me.chart[field] = mf.m.highchart_monitor(me.element[field], {
                        time: chartData.time,
                        data: chartData.data[field]
                    }, opt);
                });
                me.monitor();
            }).fail(function () {
                console.log('%cwarning', 'color: #f00;', arguments);
                //RunMonitor();
            });
    }

    RunMonitor.prototype.appendData = function (data) {
        var me = this;
        var chartData = convertData($.deepExtend(me.data, data));
        console.log('new Chart Data', chartData);
        return chartData;
    };
    RunMonitor.prototype.monitor = function (interval) {
        var me = this;
        interval = interval || 3;
        me.monitorHandle = setTimeout(function () {
            console.log('monitor interval', interval);
            var dataRequest = $.map(me.monitorList, function (requestURL, index) {
                return requestData(requestURL, mf.monitor.main.model.machineList[index]);
            });
            $.when.apply($, dataRequest)
                .pipe(mf.monitor.main.model.mergeData)
                .pipe(me.appendData.bind(me))
                .done(function (chartData) {
                    var startDate = new Date(((+chartData.time.slice(-1)[0] + 2) * 60000) - 1000 * 3600 * 24);
                    var UTCStartDate = Date.UTC(
                        startDate.getFullYear(),
                        startDate.getMonth(),
                        startDate.getMonth(),
                        startDate.getHours(),
                        startDate.getMinutes(),
                        startDate.getUTCSeconds()
                    );
                    console.log('startDate', startDate);
                    $.each(mf.monitor.main.model.fieldMap, function (field) {
                        $.each(chartData.data[field], function (index, data) {
                            if (me.chart[field].series[index]) {
                                me.chart[field].series[index].setData(data, false, true);
                                me.chart[field].series[index].update({
                                    pointStart: UTCStartDate
                                }, false);
                            }
                        });
                        me.chart[field].redraw();
                    });
                    me.monitor(20);
                }).fail(function () {
                    console.log('%cwarning', 'color: #f00;', arguments);
                    me.monitor(5);
                });
        }, interval * 1000);
    };
    RunMonitor.prototype.stop = function () {
        clearTimeout(this.monitorHandle);
        this.monitorHandle = null;
    };

    mf.monitor.main.index = new er.Action({
        model: mf.monitor.main.model.index,
        view: new er.View({
            template: 'mf_monitor_main_index',
            UI_PROP: {}
        }),
        STATE_MAP: {},

        onenter: function () {
            console.log('onenter');
            mf.onenter();
        },
        onafterloadmodel: function () {

        },
        onafterrepaint: function () {
            console.log('onafterrepaint');
        },
        onafterrender: function () {
            console.log('onafterrender');
        },
        onentercomplete: function () {
            console.log('onentercomplete');
            mf.loaded();
            var action = this;
            var model = action.model;

            var monitorChart = new RunMonitor('#monitorChart', -model.get('days'));
            window.monitor = monitorChart;
            model.set('monitorChart', monitorChart);
            var monitorChartContainer = $('#monitorChart');
            esui.get('viewModalNormal').onclick = function () {
                monitorChartContainer.removeClass('vertical-modal');
            };
            esui.get('viewModalVertical').onclick = function () {
                monitorChartContainer.addClass('vertical-modal');
            };
        },
        onleave: function () {
            console.log('onleave');
            var monitorChart = this.model.get('monitorChart');
            monitorChart.stop();
        }
    });
})();