/**
 * @file Generated by er-sync
 * @author killeryyl<longgeyang@jesgoo.com>
 * @date Fri Mar 27 2015 15:20:13 GMT+0800 (CST)
 * Copyright (c) 2015 jesgoo.com, Inc. All Rights Reserved
 */
(function () {

    mf.index.report.dayMedias = new er.Action({
        model: mf.index.report.model.dayMedias,
        view: new er.View({
            template: 'mf_index_report_dayMedias',
            UI_PROP: {
                dayMediasDate: {
                    range: mf.index.reportRange
                }
            }
        }),
        STATE_MAP: {
            date: mf.getDateString(mf.getDate(-1)),
            page: 0,
            pageSize: mf.PAGER_MODEL.pageSizes[0].value,
            pageSizes: mf.PAGER_MODEL.pageSizes
        },

        onenter: function () {
            console.log('onenter');
        },
        onafterrepaint: function () {
            console.log('onafterrepaint');
        },
        onafterrender: function () {
            console.log('onafterrender');
            var action = this;
            var model = action.model;

            var date = esui.get('dayMediasDate');
            date.onchange = mf.m.utils.nextTickWrapper(function (value) {
                console.log('date change', value);
                mf.subActionRefresh(action, {
                    valueAsDate: value,
                    date: mf.getDateString(value)
                });
            }, date);

            var dayMediasListTable = esui.get('dayMediasList');
            dayMediasListTable.onsort = mf.m.utils.nextTickWrapper(function (orderField, order) {
                var orderBy = orderField.field;
                order = order == 'asc' ? 1 : -1;
                dayMediasListTable.datasource.sort(function (a, b) {
                    return a[orderBy] > b[orderBy] ? order : -order;
                });
                dayMediasListTable.render();
            }, dayMediasListTable);
        },
        onentercomplete: function () {
            console.log('onentercomplete');
            var action = this;
            var model = action.model;
            var $element = $('#dayMediasChart');
            mf.m.highchart_drill('#dayMediasChart',
                model.get('lists'), model.get('date'),
                function (event) {
                    if (event.point.media) {
                        $element.attr({
                            'data-cmd': 'step_media',
                            'data-media': event.point.media,
                            'data-name': event.point.name
                        });
                        $element.trigger('click');
                        $element.attr({
                            'data-cmd': null,
                            'data-media': null,
                            'data-name': null
                        });
                    }
                }
            );
            var data = model.get('lists');
            if (data.length) {
                var total = data.reduce(function (memory, n) {
                    memory.request += n.request;
                    memory.served_request += n.served_request;
                    memory.impression += n.impression;
                    memory.click += n.click;
                    memory.income += n.income;
                    return memory;
                }, {
                    media: null,
                    name: '总计',
                    request: 0,
                    served_request: 0,
                    impression: 0,
                    click: 0,
                    income: 0
                });
                if (total.impression) {
                    total.ctr = total.click / total.impression * 100;
                    total.cpm = total.income / total.impression * 1000;
                    total.fr = total.impression / total.request * 100;
                }
            }

            mf.mockPager(data, {
                pager: esui.get('dayMediasPager'),
                pageSizer: esui.get('dayMediasPageSize'),
                table: esui.get('dayMediasList')
            }, {
                afterSort: function (dataList, targets, opt) {
                    total && (targets.table.datasource || []).unshift(total);
                }
            })();
        },
        onleave: function () {
            console.log('onleave');
        }
    });
})();