/**
 * @file Generated by er-sync
 * @author killeryyl<longgeyang@jesgoo.com>
 * @date Fri Mar 27 2015 15:20:13 GMT+0800 (CST)
 * Copyright (c) 2015 jesgoo.com, Inc. All Rights Reserved
 */
(function () {
    var FIELDS = function (model) {
        return [
            {
                "field": "date",
                "title": "日期",
                "content": "date",
                "sortable": 1
            }/*,
            {
                "field": "request",
                "title": "请求数",
                "content": mf.getFieldContentLess('request'),
                "sortable": 1,
                "align": "right"
            },
            {
             "field": "served_request",
             "title": "有效请求数",
             "content": "served_request",
             "sortable": 1
             }*/,
             {
                "field": "impression",
                "title": "展现数",
                "content": mf.getFieldContentLess('impression'),
                "sortable": 1,
                "align": "right"
            },
            {
                "field": "click",
                "title": "点击数",
                "content": mf.getFieldContentLess('click'),
                "sortable": 1,
                "align": "right"
            },
            {
                "field": "income",
                "title": "收入",
                "content": mf.getFieldContentMoney('income'),
                "sortable": 1,
                "align": "right"
            },
            {
                "field": "ctr",
                "title": "点击率",
                "content": mf.getFieldContentPercent('ctr'),
                "sortable": 1,
                "align": "right"
            },
            {
                "field": "fr",
                "title": "填充率",
                "content": mf.getFieldContentPercent('fr'),
                "sortable": 1,
                "align": "right"
            },
            {
                "field": "cpm",
                "title": "千次展现收入",
                "content": mf.getFieldContentMoney('cpm'),
                "sortable": 1,
                "align": "right"
            }/*,
             {
             "field": "acp",
             "title": "平均点击单价",
             "content": "acp",
             "sortable": 1
             }*/
        ];
    };
    mf.index.report.model.dailyPosition = new er.Model({
        QUERY_MAP: {},
        LOADER_LIST: ['modelLoader'],
        modelLoader: new er.Model.Loader(function () {
            console.log('modelLoader');
            var loader = this;
            var dateRegion = loader.get('dateRegion').replace(/\-/g, '').split(',');

            loader.stop();
            mf.parallelAjax([
                {
                    url: '/config',
                    cache: true
                },
                {
                    url: '/report/adslot/' + loader.get('adslot') + '/daily/' + dateRegion[0] + '-' + dateRegion[1],
                    errorMessage: '分日数据获取失败，请重试。'
                }/*,
                {
                    url: '/report/media/' + loader.get('media') + '/adslot/daily/' + dateRegion[0] + '-' + dateRegion[1],
                    errorMessage: '所属广告位单日数据获取失败，请重试。'
                },
                {
                    url: '/report/media/' + loader.get('media') + '/daily/' + dateRegion[0] + '-' + dateRegion[1],
                    errorMessage: '分日数据获取失败，请重试。'
                }*/
            ], function (config, AdslotData, reportData, mediaData) {

                loader.set('config', config);
                /*$.each(reportData, function (date, row) {
                    var dayTotal = {
                        request: 0,
                        served_request: 0,
                        impression: 0,
                        click: 0,
                        income: 0
                    };
                    var dayTotalAfter = {
                        request: 0,
                        served_request: 0,
                        impression: 0,
                        click: 0,
                        income: 0
                    };
                    var mediaDayData = mf.m.utils.deepSearch(mediaData, date, 'date');
                    if (!mediaDayData) return true;
                    $.each(row, function (index, adslot) {
                        dayTotal.request += adslot.request || 0;
                        dayTotal.served_request += adslot.served_request || 0;
                        dayTotal.impression += adslot.impression || 0;
                        dayTotal.click += adslot.click || 0;
                        dayTotal.income += adslot.income || 0;
                    });
                    if (mediaDayData.request !== dayTotal.request
                        || mediaDayData.served_request !== dayTotal.served_request
                        || mediaDayData.impression !== dayTotal.impression
                        || mediaDayData.click !== dayTotal.click
                        || mediaDayData.income !== dayTotal.income
                    ) {
                        $.each(row, function (index, adslot) {
                            if (dayTotal.request) {
                                adslot.request = Math.floor(adslot.request / dayTotal.request * mediaDayData.request);
                            }
                            if (dayTotal.served_request) {
                                adslot.served_request = Math.floor(adslot.served_request / dayTotal.served_request * mediaDayData.served_request);
                            }
                            if (dayTotal.impression) {
                                adslot.impression = Math.floor(adslot.impression / dayTotal.impression * mediaDayData.impression);
                            }
                            if (dayTotal.click) {
                                adslot.click = Math.floor(adslot.click / dayTotal.click * mediaDayData.click);
                            }
                            if (dayTotal.income) {
                                adslot.income = Math.floor(adslot.income / dayTotal.income * mediaDayData.income * 100) / 100;
                            }
                        });
                        $.each(row, function (index, adslot) {
                            dayTotalAfter.request += adslot.request || 0;
                            dayTotalAfter.served_request += adslot.served_request || 0;
                            dayTotalAfter.impression += adslot.impression || 0;
                            dayTotalAfter.click += adslot.click || 0;
                            dayTotalAfter.income += adslot.income || 0;
                        });
                        if (row[0]) {
                            row[0].request += mediaDayData.request - dayTotalAfter.request;
                            row[0].served_request += mediaDayData.served_request - dayTotalAfter.served_request;
                            row[0].impression += mediaDayData.impression - dayTotalAfter.impression;
                            row[0].click += mediaDayData.click - dayTotalAfter.click;
                            row[0].income += mediaDayData.income - dayTotalAfter.income;
                        }
                        $.each(row, function (index, adslot) {
                            if (adslot.impression) {
                                adslot.cpm = adslot.income / adslot.impression * 1000;
                                adslot.ctr = adslot.click / adslot.impression * 100;
                            }
                        });
                    }
                });*/
                /*var currentAdslot = loader.get('adslot');
                var AdslotData = $.map(reportData, function (row, date) {
                    var data = mf.m.utils.deepSearch(row, currentAdslot, 'adslot');
                    if (data) {
                        data.date = date;
                        return data;
                    }
                });*/

                var orderBy = 'date';
                AdslotData.sort(function (a, b) {
                    return a[orderBy] > b[orderBy] ? -1 : 1;
                });
                loader.set('order', 'desc');
                loader.set('orderBy', orderBy);
                loader.set('lists', AdslotData);
                loader.set('fields', FIELDS(loader));

                loader.start();
            });
        })
    });
})();