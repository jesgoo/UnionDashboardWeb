/**
 * @file Generated by er-sync
 * @author killeryyl<longgeyang@jesgoo.com>
 * @date Wed Mar 18 2015 14:40:37 GMT+0800 (CST)
 * Copyright (c) 2015 jesgoo.com, Inc. All Rights Reserved
 */
(function () {

    mf.index.media.sitePosition = new er.Action({
        model: mf.index.media.model.sitePosition,
        view: new er.View({
            template: 'mf_index_media_sitePosition',
            UI_PROP: {
                list: {
                    subrow: 1,
                    subrowMutex: 0
                    //select: 'single',
                    //selectMode: 'line'
                }
            }
        }),
        STATE_MAP: {
            page: 0,
            pageSize: mf.PAGER_MODEL.pageSize,
            pageSizes: mf.PAGER_MODEL.pageSizes
        },

        onenter: function () {
            console.log('onenter');
            mf.onenter();
        },
        onbeforemodelload: function () {
            console.log('onafterrepaint');
        },
        onafterrender: function () {
            console.log('onafterrender');
        },
        onentercomplete: function () {
            console.log('onentercomplete');
            mf.loaded();
            var action = this;
            var model = action.model;
            var table = esui.get('list');
            var pager = esui.get('pager');
            var pageSizer = esui.get('pageSize');
            var sitePositionCount = esui.get('sitePositionCount');
            var dataList = model.get('list');
            var config = model.get('config');
            var sitePositionList = model.get('sitePositionList');
            var sitePositionFieldInConfig = mf.mockFieldInConfig(sitePositionList);
            var operateData = mf.operateDataInConfigField(sitePositionList);
            var emptySitePosition = {};
            emptySitePosition[sitePositionFieldInConfig('media')] = model.get('siteId');
            emptySitePosition = mf.initEntityInConfig(sitePositionList, emptySitePosition);
            table.order = 'asc';
            table.orderBy = sitePositionFieldInConfig('id');
            var saveRow = function (rowIndex) {
                var row = table.datasource[rowIndex];
                if (mf.tableSavingValidator.call(table, row, table.fields)) {
                    return mf.parallelAjax({
                        type: 'POST',
                        url: '/adslot' + (row._isNew ? '' : '/' + operateData.get(row, 'id')),
                        data: mf.grepDataInConfig(row, sitePositionList)
                    }, function (result) {
                        var newData = result[0];
                        if (row._isNew) {
                            dataList.unshift(newData);
                            sitePositionCount.setContent(dataList.length);
                        } else {
                            var idField = sitePositionFieldInConfig('id');
                            var index = mf.m.utils.indexOfArray(dataList, row[idField], idField);
                            index > -1 && (dataList[index] = newData);
                        }
                        table.datasource[rowIndex] = newData;
                        table.render();
                    });
                } else {
                    return false;
                }
            };
            var refreshTable = mf.mockPager(dataList, {
                pager: pager,
                pageSizer: pageSizer,
                table: table
            }, {
                editToSave: function (value, options, editor) {
                    var row = table.datasource[options.rowIndex];
                    if (!row._isNew) {
                        return saveRow(options.rowIndex);
                    }
                }
            });
            refreshTable();
            var jssdkDomain = location.host.replace(/^union\./i, 'cdn.');
            jssdkDomain = jssdkDomain.replace('cdn.moogos', 'c3.moogos');
            //var jssdkDomain = location.host.replace(/^union\./i, 'api.');

            table.onedit = (function (fn) {
                return function (value, options) {
                    var row = table.datasource[options.rowIndex];
                    switch (options.field.listKey) {
                        case 'type':
                            var r = mf.m.utils.deepSearch('children', config.maps.sitePositionTypeMap,
                                value, 'value', 0);
                            operateData.set(row, 'height', r.heightDefault);
                            operateData.set(row, 'hasCloseBtn', false);
                            if (r.value == config.maps.sitePositionType.popups) {
                                operateData.set(row, 'frequency',
                                    {"period": 86400, "times": 1, "percent":100, "percentBackup": 1});
                            } else {
                                operateData.set(row, 'frequency', {});
                            }
                            break;
                        case 'displayType':
                            if (value === config.maps.sitePositionDisplayType['float']) {
                                operateData.set(row, 'position', config.maps.displayPositionType.bottom);
                                operateData.set(row, 'hasCloseBtn', true);
                                operateData.set(row, 'blank', false);
                            }
                            break;
                    }
                    fn.apply(this, arguments);
                };
            })(table.onedit);
            var preview = mf.m.utils.throttle(function (rowIndex) {
                //mf.m.preview.previewHTML(
                //    mf.reflectDataInConfig(table.datasource[rowIndex], sitePositionList),
                //'positionPreview'
                //);
                mf.m.preview.previewJS(
                    mf.reflectDataInConfig(table.datasource[rowIndex], sitePositionList),
                    'positionPreview'
                );
            }, 300);
            var previewWithCustomJS = function (adslotData) {
                return mf.m.utils.throttle(function (js, data) {
                    //mf.m.preview.previewHTML(
                    //    mf.reflectDataInConfig(table.datasource[rowIndex], sitePositionList),
                    //'positionPreview'
                    //);
                    adslotData.js = js;
                    adslotData.data = data;
                    mf.m.preview.previewCustomJS(
                        adslotData,
                        'positionPreview'
                    );
                }, 300);
            };
            table._rowOverHandler = function (rowIndex) {
                esui.Table.prototype._rowOverHandler.call(this, rowIndex);
                preview(rowIndex);
            };
            action.subAction = {};
            table.onsubrowopen = mf.m.utils.nextTickWrapper(function (index, item) {
                var me = this;
                var subRow = me.getSubrow(index);
                console.log('open subrow', subRow);
                if (action.subAction[index]) {
                    action.subAction[index].leave();
                }
                var adslotData = mf.reflectDataInConfig(item, sitePositionList);
                action.subAction[index] = er.controller.loadSub(
                    subRow.id,
                    'mf.index.media.siteTemplate',
                    {
                        queryMap: {
                            adslot: operateData.get(item, 'id'),
                            adslotData: adslotData
                        }
                    }
                );
                action.subAction[index].preview = previewWithCustomJS(adslotData);
            });
            table.onsubrowclose = function (index) {
                var subAction = action.subAction[index];
                if (subAction && subAction.leave) {
                    subAction.leave();
                    action.subAction[index] = null;
                }
            };
            $.extend(action._controlMap, esui.init(table.main));

            var advancedEditor = esui.get('advancedEditor');
            advancedEditor.oncommand = function (opt) {
                var index = opt.index;
                if (index === 0) {
                    var rowIndex = model.get('currentEditingRow');
                    var row = table.datasource[rowIndex];
                    row.config || (row.config = {});
                    var advancedConfig = action.subAction.advanced.setValue(row.config);
                    console.log('advancedConfig', row.config, advancedConfig);
                    if (!row._isNew) {
                        var savor = saveRow(rowIndex);
                        savor && savor.done(function () {
                            advancedEditor.hide();
                            action.subAction.advanced.leave();
                            action.subAction.advanced = null;
                        });
                        return false;
                    }
                } else {
                    action.subAction.advanced.leave();
                    action.subAction.advanced = null
                }
            };
    
            var experimentEditor = esui.get('experimentEditor');
            experimentEditor.oncommand = function (opt) {
                var index = opt.index;
                if (index === 0) {
                    var rowIndex = model.get('currentEditingRow');
                    var row = table.datasource[rowIndex];
                    var experimentConfig = action.subAction.experiment.setValue();
                    if (experimentConfig === false) {
                        return false;
                    }
                    row.experiment = experimentConfig;
                    if (!row._isNew) {
                        var savor = saveRow(rowIndex);
                        savor && savor.done(function () {
                            experimentEditor.hide();
                            action.subAction.experiment.leave();
                            action.subAction.experiment = null;
                        });
                        return false;
                    }
                } else if (index == 2) {
                    action.subAction.experiment.formatJSON();
                    return false;
                } else if (index == 3) {
                    action.subAction.experiment.sample();
                    return false;
                } else {
                    action.subAction.experiment.leave();
                    action.subAction.experiment = null
                }
            };
            
            model.set(
                'commands',
                mf.clickCommand.register(
                    [
                        {
                            cmd: 'search',
                            handle: function (options) {
                                var text = esui.get('sitePositionName').getValue();
                                var filter;
                                if (text) {
                                    var valueRegExp = mf.m.utils.makeRegExp(text, 'i');
                                    filter = function (obj) {
                                        return valueRegExp.test(operateData.get(obj, 'name'));
                                    };
                                }
                                refreshTable({
                                    page: 0,
                                    filter: filter
                                });
                            }
                        },
                        {
                            cmd: 'add',
                            handle: function (options) {
                                var newRow = $.deepExtend({}, emptySitePosition);
                                newRow = mf.grepDataInConfig(newRow, sitePositionList);
                                newRow._isNew = true;
                                table.datasource = table.datasource || [];
                                table.datasource.unshift(newRow);
                                table.render();
                            }
                        },
                        {
                            cmd: 'delete_add',
                            handle: function (options) {
                                table.datasource.splice(options.index, 1);
                                table.render();
                            }
                        },
                        {
                            cmd: 'save',
                            handle: function (options) {
                                return saveRow(options.index);
                            }
                        },
                        {
                            cmd: 'copy',
                            handle: function (options) {
                                var row = table.datasource[options.index];
                                var newRow = $.deepExtend({}, emptySitePosition, row);
                                newRow = mf.grepDataInConfig(newRow, sitePositionList);
                                newRow._isModify = true;
                                newRow._isNew = true;
                                table.datasource.unshift(newRow);
                                table.render();
                            }
                        },
                        {
                            cmd: 'code',
                            handle: function (options) {
                                var row = table.datasource[options.index];
                                esui.Dialog.alert({
                                    title: '网站媒体代码',
                                    content: mf.etplFetch('position_jssdk_code', {
                                        domain: jssdkDomain,
                                        adslot: operateData.get(row, 'id'),
                                        channelId: T.cookie.get('union_default_channel')
                                    })
                                });
                            }
                        },
                        {
                            cmd: 'advanced',
                            handle: function (options) {
                                var row = table.datasource[options.index];
                                advancedEditor.show();
                                if (action.subAction.advanced) {
                                    action.subAction.advanced.leave();
                                }
                                action.subAction.advanced = er.controller.loadSub(
                                    advancedEditor.getBody().id,
                                    'mf.index.media.sitePositionAdvanced',
                                    {
                                        queryMap: {
                                            requestData: row.config
                                        }
                                    }
                                );
                                model.set('currentEditingRow', options.index);
                            }
                        },
                        {
                            cmd: 'experiment',
                            handle: function (options) {
                                var row = table.datasource[options.index];
                                experimentEditor.show();
                                if (action.subAction.experiment) {
                                    action.subAction.experiment.leave();
                                }
                                action.subAction.experiment = er.controller.loadSub(
                                    experimentEditor.getBody().id,
                                    'mf.index.media.siteExperiment',
                                    {
                                        queryMap: {
                                            requestData: row.experiment
                                        }
                                    }
                                );
                                model.set('currentEditingRow', options.index);
                            }
                        }
                    ],
                    {
                        region: '#' + action.view.target,
                        rewrite: true
                    }
                )
            );
            if (model.get('addNew')) {
                $('[data-cmd=add]', '#' + action.view.target).trigger('click');
            }
        },
        onleave: function () {
            console.log('onleave');
            var action = this;
            $.each(action.subAction || {}, function (index, subAction) {
                if (subAction && subAction.leave) {
                    subAction.leave();
                }
            });
            action.subAction = null;
            var commands = this.model.get('commands');
            commands && mf.clickCommand.dispose(commands);
        }
    });
})();