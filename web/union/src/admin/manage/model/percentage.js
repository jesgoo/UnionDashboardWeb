/**
 * @file Generated by er-sync
 * @author killeryyl<longgeyang@jesgoo.com>
 * @date Mon Jun 15 2015 19:28:07 GMT+0800 (CST)
 * Copyright (c) 2015 jesgoo.com, Inc. All Rights Reserved
 */
(function () {
    var FIELDS = function (model) {
        var channelList = model.get('channelList');
        var mediaList = model.get('mediaList');
        var adslotList = model.get('adslotList');
        var channelNames = model.get('channelNames');
        var mediaNames = model.get('mediaNames');
        var adslotNames = model.get('adslotNames');
        channelList.forEach(function (n, key) {
            channelNames[n.value] = n.name;
        });
        mediaList.forEach(function (n, key) {
            mediaNames[n.value] = n.name;
        });
        adslotList.forEach(function (n, key) {
            adslotNames[n.value] = n.name;
        });
        var needFieldLists = {
            media: {
                sortable: true,
                stable: 1,
                width: 200,
                title: '媒体',
                field: 'media',
                content: function (item) {
                    return mediaNames[item.media] || '-';
                }/*,

                datasource: mediaList,
                edittype: 'select',
                editable: function (item) {
                    return !!item._isNew;
                },
                validator: function (value) {
                    if (!value) {
                        return '必须选定一个媒体！';
                    }
                }*/
            },
            channel: {
                sortable: true,
                stable: 1,
                width: 200,
                title: '渠道',
                field: 'channel',
                content: function (item) {
                    return channelNames[item.channel] || '-';
                },
                datasource: channelList,
                edittype: 'select',
                editable: function (item) {
                    return !!item._isNew;
                }
            },
            adslot: {
                sortable: true,
                stable: 1,
                width: 200,
                title: '广告位',
                field: 'adslot',
                content: function (item) {
                    return adslotNames[item.adslot] || '-';
                },
                edittype: 'select',
                editable: function (item) {
                    return !!item._isNew && item.media;
                },
                beforeEdit: function (item, row, col, field) {
                    field.datasource = adslotList.filter(function (n) {
                        return n.media === item.media;
                    });
                    field.datasource.unshift(adslotList[0]);
                },
                validator: function (value) {
                    if (!value) {
                        return '必须选定一个媒体！';
                    }
                }
            },
            mediaPercentage: {
                stable: 1,
                width: 100,
                title: '媒体分成比例',
                field: 'media_percentage',
                editable: 1,
                edittype: 'int',
                content: function (item, index) {
                    return item.media_percentage ? item.media_percentage + '%' : '-';
                },
                validator: function (value) {
                    value = +value;
                    if (value < 0 || value > 100) {
                        return '值范围[0-100]';
                    }
                }
            },
            channelPercentage: {
                stable: 1,
                width: 100,
                title: '渠道分成比例',
                field: 'channel_percentage',
                editable: 1,
                edittype: 'int',
                content: function (item, index) {
                    return item.channel_percentage ? item.channel_percentage + '%' : '-';
                },
                validator: function (value) {
                    value = +value || 0;
                    if (value < 0 || value > 100) {
                        return '值范围[0-100]';
                    }
                }
            },
            modified_time: {
                title: '修改时间',
                sortable: true,
                field: 'modified_time'
            },
            operation: {
                stable: 1,
                width: 96,
                title: '操作',
                content: function (item, index) {
                    var ops = [];
                    if (item._isModify) {
                        ops.unshift('<a data-cmd="save" data-index="' + index + '">保存</a>');
                    }
                    if (item._isNew) {
                        ops.unshift('<a data-cmd="delete_add" data-index="' + index + '">删除</a>');
                    }
                    return ops.join('&nbsp;') || '-';
                }
            }
        };
        return mf.mockTableFields(needFieldLists, {});
    };
    var MEDIA_FIELDS = function (model) {
        var needFieldLists = {
            id: {
                sortable: true,
                title: 'ID',
                field: 'id',
                content: 'id'
            },
            name: {
                sortable: true,
                title: '名称',
                field: 'name',
                content: 'name'
            }
        };
        return mf.mockTableFields(needFieldLists, {});
    };
    mf.admin.manage.model.percentage = new er.Model({
        QUERY_MAP: {},
        LOADER_LIST: ['modelLoader'],
        modelLoader: new er.Model.Loader(function () {
            console.log('modelLoader');
            var loader = this;

            loader.stop();
            mf.parallelAjax([
                '/admin/percentage',
                '/admin/channel',
                '/admin/media',
                '/admin/adslot'
            ], function (percentage, channel, media, adslot) {

/*
                channel.unshift({
                    "id": "0",
                    "name": "自有渠道"
                });
*/
                var channelList = channel.map(function (n) {
                    return {
                        name: n.id + '_' + n.name,
                        value: n.id
                    }
                });
                channelList.sort(function (a, b) {
                    return a.id > b.id ? 1 : -1;
                });
                var mediaList = media.map(function (n) {
                    return {
                        name: n.id + '_' + n.name,
                        value: n.id
                    }
                });
                mediaList.sort(function (a, b) {
                    return a.id > b.id ? 1 : -1;
                });
                var adslotList = adslot.map(function (n) {
                    return {
                        name: n.id + '_' + n.name,
                        media: n.media,
                        value: n.id
                    }
                });
                adslotList.sort(function (a, b) {
                    return a.id > b.id ? 1 : -1;
                });
                adslotList.unshift({
                    "value": "s0000000",
                    "media": "nothing",
                    "name": "所有从属广告位"
                });

                var channelNames = {};
                var mediaNames = {};
                var adslotNames = {};
                channelList.forEach(function (n, key) {
                    channelNames[n.value] = n.name;
                });
                mediaList.forEach(function (n, key) {
                    mediaNames[n.value] = n.name;
                });
                adslotList.forEach(function (n, key) {
                    adslotNames[n.value] = n.name;
                });
                loader.set('channelList', channelList);
                loader.set('mediaList', mediaList);
                loader.set('adslotList', adslotList);
                loader.set('channelNames', channelNames);
                loader.set('mediaNames', mediaNames);
                loader.set('adslotNames', adslotNames);
                loader.set('media', media);
                loader.set('mediaListFields', MEDIA_FIELDS(loader));
                percentage.forEach(function (n) {
                    n.mediaName = mediaNames[n.media];
                });
                percentage.forEach(function (n) {
                    n.channelName = channelNames[n.channel];
                });
                percentage.forEach(function (n) {
                    n.adslotName = adslotNames[n.adslot];
                });
                loader.set('emptyPercentage', {
                    channel: '00000000',
                    media: '',
                    adslot: 's0000000',
                    media_percentage: 100,
                    channel_percentage: 0
                });

                mf.initEntities({
                    loader: loader,
                    entities: percentage,
                    fields: FIELDS(loader)
                });

                loader.start();
            });
        })
    });
})();