/**
 * @file Generated by er-sync, module
 * @author killeryyl<longgeyang@jesgoo.com>
 * @date Sun Sep 28 2014 10:29:14 GMT+0800 (中国标准时间)
 * Copyright (c) 2015 jesgoo.com, Inc. All Rights Reserved
 * shortcut mf.m.databaseSQL
 */
(function (exports, module) {
    var databaseSQL = function (url) {
        mf.loaded();
        var text = esui.get('text');
        var sqlBox = esui.get('sql');
        var logBox = esui.get('log');
        var duringTime = 0;
        var autoSave = function () {
            var value = logBox.getValue();
            if (window.localStorage) {
                window.localStorage['sql'] = value;
            }
        };
        var getAutoSave = function () {
            var value;
            if (window.localStorage) {
                value = window.localStorage['sql'];
            }
            logBox.setValue(value || '');
        };
        getAutoSave();
        esui.get('clearSql').onclick = function () {
            sqlBox.setValue('');
        };
        esui.get('clearLog').onclick = function () {
            logBox.setValue('');
            autoSave();
        };
        var table = esui.get('list');
        var execBtn = esui.get('exec');
        execBtn.onclick = function () {
            var sql = $.trim(sqlBox.getValue());
            if (!sql) {
                text.setValue('请输入');
                return false;
            }
            if (/^\s*(?:select|delete|create|update|if|exec|insert|alter|drop)/i.test(sql) == false) {
                text.setValue('错误语句');
                return false;
            }
            var logs = $.grep(sqlBox.getValueAsArray(), function (n) {
                return n;
            });
            duringTime = new Date();
            logs.unshift(T.date.format(duringTime, mf.TIME_FORMAT) + ' - Exec SQL');
            logBox.prependLines(logs);
            mf.post(url, {
                sql: sql
            }, function (model) {
                var now = new Date();
                logBox.prependLines([
                        T.date.format(now, mf.TIME_FORMAT)
                        + ' - Complete Cost ' + (now - duringTime) + 'ms'
                ]);
                autoSave();
                if (!model.fields) {
                    $(table.main).hide();
                    $(text.main).show();
                    text.setValue(model.list.join('\n'));
                } else {
                    table.fields = $.map(model.fields, function (n) {
                        return {
                            content: n,
                            title: n
                        };
                    });
                    table.fields.unshift({
                        title: '',
                        stable: 1,
                        width: 50,
                        align: 'center',
                        content: function (item, index) {
                            return index + 1;
                        }
                    });
                    table.datasource = model.list;
                    $(table.main).show();
                    $(text.main).hide();
                    table.render();
                }

            });
        };
    };
    exports.databaseSQL = databaseSQL;
})(mf && mf.m || exports || {}, mf || module);